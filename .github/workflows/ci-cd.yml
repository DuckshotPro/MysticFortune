name: CI/CD Pipeline for fortunetellertarot.cards-MysticFortune

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Set deployment variables
      id: vars
      run: |
        if [[ $GITHUB_REF == 'refs/heads/main' ]]; then
          echo "deploy_env=production" >> $GITHUB_OUTPUT
          echo "container_name=mysticfortune" >> $GITHUB_OUTPUT
          echo "virtual_host=fortunetellertarot.cards,www.fortunetellertarot.cards" >> $GITHUB_OUTPUT
          echo "image_tag=latest" >> $GITHUB_OUTPUT
          echo "branch=main" >> $GITHUB_OUTPUT
        else
          echo "deploy_env=development" >> $GITHUB_OUTPUT
          echo "container_name=mysticfortune-dev" >> $GITHUB_OUTPUT
          echo "virtual_host=dev.fortunetellertarot.cards" >> $GITHUB_OUTPUT
          echo "image_tag=dev" >> $GITHUB_OUTPUT
          echo "branch=dev" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to DP1 via SSH
      uses: appleboy/ssh-action@v1.0.3
      env:
        CONTAINER_NAME: ${{ steps.vars.outputs.container_name }}
        VIRTUAL_HOST: ${{ steps.vars.outputs.virtual_host }}
        IMAGE_TAG: ${{ steps.vars.outputs.image_tag }}
        DEPLOY_ENV: ${{ steps.vars.outputs.deploy_env }}
        BRANCH: ${{ steps.vars.outputs.branch }}
      with:
        host: 74.208.227.161
        username: cira
        key: ${{ secrets.DP1_SERVER_SSH_KEY }}
        envs: CONTAINER_NAME,VIRTUAL_HOST,IMAGE_TAG,DEPLOY_ENV,BRANCH
        script: |
          echo "Deploying branch '${BRANCH}' to ${CONTAINER_NAME}..."
          cd /home/cira/fortunetellertarot.cards-MysticFortune || exit 1

          # Git operations
          git fetch origin ${BRANCH}
          git checkout ${BRANCH}
          git pull origin ${BRANCH}

          # Podman operations
          podman build -t mysticfortune:${IMAGE_TAG} -f Dockerfile .
          podman stop ${CONTAINER_NAME} || true
          podman rm ${CONTAINER_NAME} || true

          # Run new container
          podman run -d --name ${CONTAINER_NAME} \
            -e VIRTUAL_HOST='${VIRTUAL_HOST}' \
            -e LETSENCRYPT_HOST='${VIRTUAL_HOST}' \
            -e LETSENCRYPT_EMAIL='support@crypt-ai-lytics.com' \
            -e VIRTUAL_PORT=3000 \
            -e NODE_ENV=${DEPLOY_ENV} \
            --env-file .env \
            mysticfortune:${IMAGE_TAG}
